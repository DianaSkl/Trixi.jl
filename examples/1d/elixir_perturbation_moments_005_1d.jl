using OrdinaryDiffEq
using Trixi
using Plots

equations = PerturbationMomentSystem1D(0.0, 1.0)

initial_condition = initial_condition_constant
# initial_condition = initial_condition_convergence_test
boundary_condition = BoundaryConditionDirichlet(initial_condition)
boundary_conditions = (x_neg=boundary_condition,
                       x_pos=boundary_condition)

solver = DGSEM(polydeg=3, surface_flux=flux_lax_friedrichs)

coordinates_min = (-1,)
coordinates_max = ( 1,)

mesh = TreeMesh(coordinates_min, coordinates_max, initial_refinement_level=7, n_cells_max=10_000, periodicity=false)
#semi = SemidiscretizationHyperbolic(mesh, equations, initial_condition, solver)
semi = SemidiscretizationHyperbolic(mesh, equations, initial_condition, solver, boundary_conditions=boundary_conditions)

tspan = (0.0, 0.05)
ode = semidiscretize(semi, tspan)

# At the beginning of the main loop, the SummaryCallback prints a summary of the simulation setup
# and resets the timers
summary_callback = SummaryCallback()

analysis_interval = 100

# The AnalysisCallback allows to analyse the solution in regular intervals and prints the results
analysis_callback = AnalysisCallback(semi, interval=100)

# das hier sorgt für die Ausgabe!
alive_callback = AliveCallback(analysis_interval=analysis_interval)


# The SaveSolutionCallback allows to save the solution to a file in regular intervals
save_solution = SaveSolutionCallback(interval=100,solution_variables=cons2prim)

# The StepsizeCallback handles the re-calculcation of the maximum Δt after each time step
stepsize_callback = StepsizeCallback(cfl=0.9)

save_restart = SaveRestartCallback(interval=100,save_final_restart=true)

# Create a CallbackSet to collect all callbacks such that they can be passed to the ODE solver
callbacks = CallbackSet(summary_callback, analysis_callback, alive_callback, save_solution, stepsize_callback, save_restart)



###############################################################################
# run the simulation

sol = solve(ode, CarpenterKennedy2N54(williamson_condition=false), dt=1.0, save_everystep=false, callback=callbacks);

# Print the timer summary
summary_callback()

pd = PlotData1D(sol; solution_variables=cons2prim)

# t = 0.05
x =[-0.9966666666666667, -0.99, -0.9833333333333333, -0.9766666666666667, -0.97, -0.9633333333333334, -0.9566666666666667, -0.95, -0.9433333333333334, -0.9366666666666666, -0.9299999999999999, -0.9233333333333333, -0.9166666666666666, -0.91, -0.9033333333333333, -0.8966666666666666, -0.89, -0.8833333333333333, -0.8766666666666667, -0.87, -0.8633333333333333, -0.8566666666666667, -0.85, -0.8433333333333333, -0.8366666666666667, -0.83, -0.8233333333333334, -0.8166666666666667, -0.81, -0.8033333333333333, -0.7966666666666666, -0.79, -0.7833333333333333, -0.7766666666666666, -0.77, -0.7633333333333333, -0.7566666666666666, -0.75, -0.7433333333333333, -0.7366666666666666, -0.73, -0.7233333333333334, -0.7166666666666667, -0.71, -0.7033333333333334, -0.6966666666666667, -0.69, -0.6833333333333333, -0.6766666666666666, -0.6699999999999999, -0.6633333333333333, -0.6566666666666666, -0.6499999999999999, -0.6433333333333333, -0.6366666666666667, -0.6299999999999999, -0.6233333333333333, -0.6166666666666667, -0.61, -0.6033333333333333, -0.5966666666666667, -0.59, -0.5833333333333333, -0.5766666666666667, -0.57, -0.5633333333333332, -0.5566666666666666, -0.55, -0.5433333333333332, -0.5366666666666666, -0.53, -0.5233333333333333, -0.5166666666666666, -0.51, -0.5033333333333333, -0.4966666666666666, -0.49, -0.4833333333333333, -0.4766666666666667, -0.47, -0.46333333333333326, -0.45666666666666667, -0.44999999999999996, -0.44333333333333325, -0.43666666666666665, -0.42999999999999994, -0.42333333333333334, -0.41666666666666663, -0.4099999999999999, -0.4033333333333333, -0.3966666666666666, -0.39, -0.3833333333333333, -0.3766666666666666, -0.37, -0.3633333333333333, -0.3566666666666666, -0.35, -0.34333333333333327, -0.33666666666666667, -0.32999999999999996, -0.32333333333333325, -0.31666666666666665, -0.30999999999999994, -0.30333333333333334, -0.29666666666666663, -0.2899999999999999, -0.2833333333333333, -0.2766666666666666, -0.2699999999999999, -0.2633333333333333, -0.2566666666666666, -0.25, -0.2433333333333333, -0.23666666666666658, -0.22999999999999998, -0.22333333333333327, -0.21666666666666656, -0.20999999999999996, -0.20333333333333325, -0.19666666666666666, -0.18999999999999995, -0.18333333333333324, -0.17666666666666664, -0.16999999999999993, -0.16333333333333333, -0.15666666666666662, -0.1499999999999999, -0.1433333333333333, -0.1366666666666666, -0.1299999999999999, -0.1233333333333333, -0.11666666666666659, -0.10999999999999999, -0.10333333333333328, -0.09666666666666657, -0.08999999999999997, -0.08333333333333326, -0.07666666666666666, -0.06999999999999995, -0.06333333333333324, -0.05666666666666664, -0.04999999999999993, -0.043333333333333224, -0.036666666666666625, -0.029999999999999916, -0.023333333333333317, -0.016666666666666607, -0.009999999999999898, -0.0033333333333332993, 0.0033333333333334103, 0.010000000000000009, 0.01666666666666683, 0.023333333333333428, 0.030000000000000027, 0.036666666666666625, 0.043333333333333446, 0.050000000000000044, 0.05666666666666664, 0.06333333333333346, 0.07000000000000006, 0.07666666666666666, 0.08333333333333348, 0.09000000000000008, 0.09666666666666668, 0.1033333333333335, 0.1100000000000001, 0.1166666666666667, 0.1233333333333333, 0.13000000000000012, 0.13666666666666671, 0.1433333333333333, 0.15000000000000013, 0.15666666666666673, 0.16333333333333333, 0.17000000000000015, 0.17666666666666675, 0.18333333333333335, 0.19000000000000017, 0.19666666666666677, 0.20333333333333337, 0.2100000000000002, 0.21666666666666679, 0.22333333333333338, 0.22999999999999998, 0.2366666666666668, 0.2433333333333334, 0.25, 0.2566666666666668, 0.2633333333333334, 0.27, 0.27666666666666684, 0.28333333333333344, 0.29000000000000004, 0.29666666666666686, 0.30333333333333345, 0.31000000000000005, 0.31666666666666665, 0.3233333333333335, 0.33000000000000007, 0.33666666666666667, 0.3433333333333335, 0.3500000000000001, 0.3566666666666667, 0.3633333333333335, 0.3700000000000001, 0.3766666666666667, 0.3833333333333335, 0.3900000000000001, 0.3966666666666667, 0.4033333333333333, 0.41000000000000014, 0.41666666666666674, 0.42333333333333334, 0.43000000000000016, 0.43666666666666676, 0.44333333333333336, 0.4500000000000002, 0.4566666666666668, 0.4633333333333334, 0.4700000000000002, 0.4766666666666668, 0.4833333333333334, 0.49, 0.4966666666666668, 0.5033333333333334, 0.51, 0.5166666666666668, 0.5233333333333334, 0.53, 0.5366666666666668, 0.5433333333333334, 0.55, 0.5566666666666669, 0.5633333333333335, 0.5700000000000001, 0.5766666666666667, 0.5833333333333335, 0.5900000000000001, 0.5966666666666667, 0.6033333333333335, 0.6100000000000001, 0.6166666666666667, 0.6233333333333335, 0.6300000000000001, 0.6366666666666667, 0.6433333333333335, 0.6500000000000001, 0.6566666666666667, 0.6633333333333333, 0.6700000000000002, 0.6766666666666667, 0.6833333333333333, 0.6900000000000002, 0.6966666666666668, 0.7033333333333334, 0.7100000000000002, 0.7166666666666668, 0.7233333333333334, 0.7300000000000002, 0.7366666666666668, 0.7433333333333334, 0.7500000000000002, 0.7566666666666668, 0.7633333333333334, 0.77, 0.7766666666666668, 0.7833333333333334, 0.79, 0.7966666666666669, 0.8033333333333335, 0.81, 0.8166666666666669, 0.8233333333333335, 0.8300000000000001, 0.8366666666666669, 0.8433333333333335, 0.8500000000000001, 0.8566666666666667, 0.8633333333333335, 0.8700000000000001, 0.8766666666666667, 0.8833333333333335, 0.8900000000000001, 0.8966666666666667, 0.9033333333333335, 0.9100000000000001, 0.9166666666666667, 0.9233333333333336, 0.9300000000000002, 0.9366666666666668, 0.9433333333333334, 0.9500000000000002, 0.9566666666666668, 0.9633333333333334, 0.9700000000000002, 0.9766666666666668, 0.9833333333333334, 0.9900000000000002, 0.9966666666666668];
rho = [3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 3., 2.999999999999998, 2.999999999999986, 2.9999999999998965, 2.9999999999992433, 2.999999999994711, 2.9999999999647677, 2.9999999997763798, 2.9999999986478296, 2.999999992210459, 2.999999957247164, 2.999999776423654, 2.999998885769009, 2.999994706198157, 2.999976008965268, 2.999896206142674, 2.999570917400437, 2.99829970080681, 2.993550448103895, 2.9788234309877923, 2.9532536526635265, 2.922930959029793, 2.89650576709637, 2.881223141996892, 2.8747847482250095, 2.8704275652502798, 2.864913244923068, 2.855184861560542, 2.829797425876129, 2.757387129565106, 2.6376910382060785, 2.5044072379249296, 2.380600790276865, 2.296556333032143, 2.2365761041209073, 2.1634723851816795, 2.0602643464044204, 1.9397356535955745, 1.8365276148183165, 1.7634238958790902, 1.7034436669678548, 1.619399209723129, 1.4955927620750598, 1.3623089617939144, 1.2426128704348884, 1.1702025741238575, 1.1448151384394416, 1.1350867550769157, 1.129572434749727, 1.1252152517750003, 1.1187768580030986, 1.1034942329036277, 1.0770690409702186, 1.0467463473363976, 1.0211765690122787, 1.0064495518960892, 1.001700299193203, 1.0004290825995468, 1.0001037938573294, 1.000023991034726, 1.0000052938018409, 1.0000011142309888, 1.0000002235763428, 1.000000042752833, 1.000000007789538, 1.0000000013521684, 1.000000000223618, 1.0000000000352312, 1.0000000000052878, 1.0000000000007554, 1.0000000000001026, 1.000000000000013, 1.0000000000000013, 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.];
v = [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1.0612682070672603*10^-16, 1.2489577696107706*10^-15, 9.54779279344508*10^-15, 7.316128899633405*10^-14, 5.370212031412291*10^-13, 3.75542939011297*10^-12, 2.5020663445723953*10^-11, 1.5880759959382863*10^-10, 9.602700155847404*10^-10, 5.5318959131195025*10^-9, 3.0361762551888255*10^-8, 1.5877695057340814*10^-7, 7.912900181452361*10^-7, 3.7594607739442394*10^-6, 0.000017037352711936558, 0.00007370886293416237, 0.0003047202959462311, 0.001207873906642798, 0.004589356020751835, 0.015119747314564105, 0.03357872490367118, 0.05591817664837595, 0.07637491595661783, 0.08967524294772118, 0.0959839873840238, 0.09930533080484388, 0.10219819633486821, 0.10470079420228244, 0.11069316901872352, 0.1351801224757541, 0.18060450264091452, 0.23571709231227625, 0.28641605884273147, 0.32894318833313596, 0.34777012743574326, 0.3631527313966093, 0.38248817849529915, 0.4062547160043762, 0.4278023916659617, 0.44108189673936027, 0.4434761049180631, 0.42104645471919794, 0.39471412744097584, 0.3496849036714158, 0.29996786509801704, 0.26767950411130403, 0.26112523547445804, 0.2579441306820549, 0.25235102251916347, 0.24522712660546506, 0.23094362686974787, 0.20047262408225433, 0.1517497611395067, 0.09473784382056227, 0.044105063646963184, 0.01365042961822709, 0.003615420676006717, 0.0009136381114734814, 0.00022109598985026565, 0.00005111042320768901, 0.000011278302712881374, 2.373866526453937*10^-6, 4.763307101783322*10^-7, 9.108528174858618*10^-8, 1.659568674232939*10^-8, 2.8808096672625972*10^-9, 4.76421645729071*10^-10, 7.506131248358446*10^-11, 1.1266074137655782*10^-11, 1.6106940794004452*10^-12, 2.191816300219184*10^-13, 2.838456382638757*10^-14, 3.478611683801151*10^-15, 4.0917106521423446*10^-16, 6.367609242403562*10^-18, 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.]
theta = [1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 0.9999999999999999, 0.9999999999999991, 0.9999999999999932, 0.9999999999999477, 0.9999999999996165, 0.9999999999973177, 0.9999999999821291, 0.9999999998865726, 0.9999999993141317, 0.9999999960488698, 0.9999999783142669, 0.999999886594535, 0.9999994348279317, 0.9999973148591793, 0.999987831508293, 0.9999473565211379, 0.9997823647573273, 0.9991370727055294, 0.9967156016640095, 0.9891473922090053, 0.9757731788806875, 0.9592679741381798, 0.9432715815408722, 0.9313384860764422, 0.9247325592753408, 0.9226465080087662, 0.9223094462886502, 0.9250933008388498, 0.9341051970942353, 0.9475051114272093, 0.9692330946997081, 0.9985152103200355, 1.0225878897480019, 1.0313258818800168, 1.0289351768037334, 1.012398194042676, 0.9736706508532493, 0.921155193400568, 0.8726038069933457, 0.8473183132228599, 0.8435837653721434, 0.8675031033544167, 0.919539614269702, 0.9977592206712911, 1.0729772524378642, 1.1255867061844598, 1.1549762124293812, 1.1651222947910462, 1.1669875440036097, 1.1644075244917662, 1.1521446454680209, 1.1304034165712362, 1.1000333331019945, 1.0643005634937621, 1.0307868982757278, 1.0096860127600025, 1.0025771101607996, 1.0006521613079997, 1.0001578868558632, 1.0000365031463845, 1.0000080553090718, 1.0000016955111812, 1.0000003402161917, 1.000000065057192, 1.00000001185339, 1.0000000020576048, 1.0000000003402822, 1.0000000000536124, 1.000000000008047, 1.0000000000011504, 1.0000000000001565, 1.0000000000000202, 1.0000000000000024, 1.0000000000000002, 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.]

gr()
p1 = plot(pd["rho"], ylims = (0.8,3.5), xguide="x", yguide="y", seriestype = :scatter, markersize=2);
p2 = plot!(x,rho, label = "FVM");
p3 = plot(pd["vx"], seriestype = :scatter, markersize=2)
p4 = plot!(x,v)
p5 = plot(pd["theta"], ylims = (0.0,1.5), xguide="x", yguide="y", seriestype = :scatter, markersize=2)
p6 = plot!(x,theta)

pp1 = plot(p1, p2)
pp2 = plot(p3,p4)
pp3 = plot(p5, p6)
plot(pp1,pp2, pp3, size=(1000,1000))
#savefig("plot0,05.pdf")

# #plot(pd)
# #plot!(getmesh(pd))


